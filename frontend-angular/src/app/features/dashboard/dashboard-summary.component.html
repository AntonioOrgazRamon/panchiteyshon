<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-1">Dashboard</h1>
    <p class="text-muted mb-0">Resumen general de tu actividad comercial</p>
  </div>
  <div class="d-flex gap-2">
    <a routerLink="/leads/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> Nuevo Lead</a>
    <a routerLink="/tareas/new" class="btn btn-outline-secondary"><i class="bi bi-check2-square me-1"></i> Nueva Tarea</a>
  </div>
</div>

<app-alert [message]="errorMessage()" type="error" />

@if (loading()) {
  <app-loader />
} @else if (summary()) {
  <!-- KPIs Grid -->
  <div class="row g-3 mb-4">
    <!-- Leads KPI -->
    <div class="col-md-6 col-xl-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="text-muted small fw-bold text-uppercase">Total Leads</div>
            <div class="icon-shape bg-primary-subtle text-primary rounded-circle">
              <i class="bi bi-people-fill"></i>
            </div>
          </div>
          <h2 class="display-6 mb-1">{{ summary()!.totalLeads }}</h2>
          <div class="small text-muted">
            <span class="text-success fw-medium"><i class="bi bi-arrow-up-short"></i> {{ summary()!.leadsActivos }}</span> activos
          </div>
        </div>
      </div>
    </div>

    <!-- Clientes KPI -->
    <div class="col-md-6 col-xl-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="text-muted small fw-bold text-uppercase">Clientes Activos</div>
            <div class="icon-shape bg-success-subtle text-success rounded-circle">
              <i class="bi bi-building-check"></i>
            </div>
          </div>
          <h2 class="display-6 mb-1">{{ summary()!.clientesActivos || 0 }}</h2>
          <div class="small text-muted">
            <span class="fw-medium">{{ summary()!.conversionLeadCliente | percent:'1.0-1' }}</span> tasa conv.
          </div>
        </div>
      </div>
    </div>

    <!-- Tareas KPI -->
    <div class="col-md-6 col-xl-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="text-muted small fw-bold text-uppercase">Tareas Pendientes</div>
            <div class="icon-shape bg-warning-subtle text-warning rounded-circle">
              <i class="bi bi-list-task"></i>
            </div>
          </div>
          <h2 class="display-6 mb-1">{{ summary()!.tareasPendientes }}</h2>
          <div class="small text-muted">
            @if (summary()!.tareasVencidas > 0) {
              <span class="text-danger fw-bold"><i class="bi bi-exclamation-circle"></i> {{ summary()!.tareasVencidas }} vencidas</span>
            } @else {
              <span class="text-success"><i class="bi bi-check-circle"></i> Al día</span>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Reuniones KPI -->
    <div class="col-md-6 col-xl-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="text-muted small fw-bold text-uppercase">Reuniones (Semana)</div>
            <div class="icon-shape bg-info-subtle text-info rounded-circle">
              <i class="bi bi-calendar-event"></i>
            </div>
          </div>
          <h2 class="display-6 mb-1">{{ summary()!.reunionesSemana || 0 }}</h2>
          <div class="small text-muted">
            Próximos 7 días
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Columna Izquierda: Leads (sin contactar) + Próximos vencimientos -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 pb-0">
          <h5 class="mb-0"><i class="bi bi-person-plus text-primary me-2"></i>Leads (sin contactar)</h5>
          <a routerLink="/leads" [queryParams]="{ estadoPipeline: 'nuevo' }" class="btn btn-sm btn-link text-decoration-none">Ver todo</a>
        </div>
        <div class="card-body">
          @if (leadsSinContactar().length === 0) {
            <p class="text-muted mb-0">No hay leads nuevos sin contactar.</p>
          } @else {
            <ul class="list-unstyled mb-0">
              @for (l of leadsSinContactar(); track l.id) {
                <li class="border-bottom border-secondary pb-2 mb-2">
                  <a [routerLink]="['/leads', l.id]" class="text-decoration-none fw-medium text-dark d-block">{{ l.nombre }}</a>
                  <span class="small text-muted">{{ l.empresa }}</span>
                </li>
              }
            </ul>
          }
        </div>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 pt-3 pb-0">
          <h5 class="mb-0">Próximos vencimientos</h5>
        </div>
        <div class="card-body">
          @if (upcomingTasks().length === 0) {
            <p class="text-muted">No hay tareas próximas.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover align-middle table-sm">
                <thead class="table-light">
                  <tr>
                    <th class="border-0 ps-0">Título</th>
                    <th class="border-0">Fecha</th>
                    <th class="border-0 pe-0 text-end">Acción</th>
                  </tr>
                </thead>
                <tbody>
                  @for (t of upcomingTasks(); track t.id) {
                    <tr>
                      <td class="ps-0 fw-medium">{{ t.titulo }}</td>
                      <td class="text-muted small">{{ t.fechaVencimiento | date:'MMM d' }}</td>
                      <td class="pe-0 text-end">
                        <a [routerLink]="['/tareas', t.id, 'edit']" class="btn btn-sm btn-light"><i class="bi bi-arrow-right"></i></a>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Columna Centro: Actividad Reciente -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 pt-3 pb-0">
          <h5 class="mb-0">Actividad Reciente</h5>
        </div>
        <div class="card-body">
          @if (summary()!.actividadReciente?.length) {
            <div class="timeline">
              @for (a of summary()!.actividadReciente!.slice(0, 8); track a.fecha + a.titulo) {
                <div class="timeline-item pb-3 position-relative ps-4">
                  <div class="timeline-marker position-absolute start-0 top-0 mt-1 rounded-circle bg-primary border border-white border-2" style="width: 10px; height: 10px;"></div>
                  <div class="timeline-content">
                    <div class="small text-muted mb-1">{{ a.fecha | date:'MMM d, HH:mm' }}</div>
                    <div class="fw-medium text-dark">{{ a.titulo }}</div>
                    <div class="badge bg-light text-secondary border mt-1 fw-normal" style="font-size: 0.7rem;">{{ a.tipo }}</div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="text-muted">Sin actividad reciente.</p>
          }
        </div>
      </div>
    </div>

    <!-- Columna Derecha: Para hoy -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 pb-0">
          <h5 class="mb-0"><i class="bi bi-sun text-warning me-2"></i>Para hoy</h5>
          <a routerLink="/tareas" class="btn btn-sm btn-link text-decoration-none">Ver todo</a>
        </div>
        <div class="card-body">
          @if (todayTasks().length === 0) {
            <div class="text-center py-4 text-muted">
              <i class="bi bi-cup-hot display-4 d-block mb-2 opacity-50"></i>
              <p class="mb-0">¡Todo limpio por hoy!</p>
            </div>
          } @else {
            <div class="list-group list-group-flush">
              @for (t of todayTasks(); track t.id) {
                <div class="list-group-item px-0 d-flex align-items-center gap-3 border-bottom-0">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [checked]="t.estado === 'hecha'" (change)="markAsDone(t)" [disabled]="markingId() === t.id">
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <span [class.text-decoration-line-through]="t.estado === 'hecha'" class="fw-medium">{{ t.titulo }}</span>
                      <span class="badge bg-secondary-subtle text-secondary rounded-pill" style="font-size: 0.7rem;">{{ t.prioridad }}</span>
                    </div>
                    @if (closingTime(t)) {
                      <div class="small text-muted"><i class="bi bi-clock me-1"></i>{{ closingTime(t) | date:'shortTime' }}</div>
                    }
                  </div>
                  <a [routerLink]="['/tareas', t.id, 'edit']" class="btn btn-sm btn-light text-muted"><i class="bi bi-pencil"></i></a>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}
