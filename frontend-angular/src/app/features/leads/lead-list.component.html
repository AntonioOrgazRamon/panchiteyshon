<header class="leads-page-header">
  <div class="leads-page-header__title">
    <h1 class="leads-page-header__h1">Leads</h1>
    <p class="leads-page-header__subtitle">Gestiona tus oportunidades de negocio</p>
  </div>
  <div class="leads-page-header__actions">
    <div class="btn-group" role="group">
      <button type="button" class="btn" [class.btn-primary]="viewMode() === 'table'" [class.btn-outline-primary]="viewMode() !== 'table'" (click)="viewMode.set('table')" title="Vista tabla"><i class="bi bi-table"></i></button>
      <button type="button" class="btn" [class.btn-primary]="viewMode() === 'kanban'" [class.btn-outline-primary]="viewMode() !== 'kanban'" (click)="viewMode.set('kanban')" title="Vista kanban"><i class="bi bi-kanban"></i></button>
    </div>
    <a class="btn btn-outline-secondary btn-sm" [href]="exportCsvUrl()" target="_blank" download title="Exportar CSV"><i class="bi bi-download"></i> CSV</a>
    <a class="btn btn-primary" routerLink="/leads/new"><i class="bi bi-plus-lg me-1"></i> Nuevo Lead</a>
  </div>
</header>

<app-alert [message]="message()" [type]="messageType()" />

<!-- Filtros: búsqueda prioritaria, estado y prioridad siempre visibles -->
<div class="leads-filters card border-0 shadow-sm mb-4">
  <div class="card-body p-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-4 col-lg-3">
        <label class="form-label visually-hidden">Buscar leads</label>
        <div class="input-group input-group--search">
          <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
          <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar por nombre, empresa..." [(ngModel)]="search" (ngModelChange)="load()" />
        </div>
      </div>
      <div class="col-md-2">
        <label class="form-label visually-hidden">Estado pipeline</label>
        <select class="form-select form-select-sm" [(ngModel)]="estadoPipeline" (ngModelChange)="load()">
          <option value="">Todos los estados</option>
          <option value="nuevo">Nuevo</option>
          <option value="contactado">Contactado</option>
          <option value="interesado">Interesado</option>
          <option value="reunion">Reunión</option>
          <option value="propuesta">Propuesta</option>
          <option value="cerrado">Cerrado</option>
          <option value="perdido">Perdido</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label visually-hidden">Prioridad</label>
        <select class="form-select form-select-sm" [(ngModel)]="prioridad" (ngModelChange)="load()">
          <option value="">Prioridad</option>
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>
      </div>
      <div class="col-md-auto ms-auto">
         <button class="btn btn-light btn-sm text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="false" aria-controls="advancedFilters">
           <i class="bi bi-sliders"></i> Más filtros
         </button>
      </div>
    </div>

    <div class="collapse mt-3" id="advancedFilters">
      <div class="row g-2 pt-2 border-top">
         <div class="col-md-2">
          <label class="form-label small">Canal</label>
          <select class="form-select form-select-sm" [(ngModel)]="canalOrigen" (ngModelChange)="load()">
            <option value="">Todos</option>
            <option value="whatsapp">Whatsapp</option>
            <option value="instagram">Instagram</option>
            <option value="llamada">Llamada</option>
            <option value="web">Web</option>
            <option value="referido">Referido</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Creación desde</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="fechaCreacionDesde" (ngModelChange)="load()" />
        </div>
        <div class="col-md-2">
          <label class="form-label small">Creación hasta</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="fechaCreacionHasta" (ngModelChange)="load()" />
        </div>
        <div class="col-md-2">
          <label class="form-label small">Ticket min</label>
          <input type="number" class="form-control form-control-sm" [(ngModel)]="ticketMin" (ngModelChange)="load()" placeholder="0" min="0" />
        </div>
        <div class="col-md-2">
          <label class="form-label small">Ticket max</label>
          <input type="number" class="form-control form-control-sm" [(ngModel)]="ticketMax" (ngModelChange)="load()" placeholder="Max" min="0" />
        </div>
      </div>
    </div>
  </div>
</div>

@if (loading()) {
  <app-loader />
} @else {
  @if (viewMode() === 'table') {
    <div class="card border-0 shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-4">Nombre / Empresa</th>
              <th>Contacto</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Ticket</th>
              <th class="text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (l of leads(); track l.id) {
              <tr>
                <td class="ps-4">
                  <div class="fw-medium text-dark">{{ l.nombre }}</div>
                  <div class="small text-muted">{{ l.empresa }}</div>
                </td>
                <td>
                  <div class="small"><i class="bi bi-telephone me-1 text-muted"></i> {{ l.telefono }}</div>
                  @if (l.email) { <div class="small text-muted"><i class="bi bi-envelope me-1"></i> {{ l.email }}</div> }
                </td>
                <td><span class="badge badge-pipeline-{{ l.estadoPipeline }}">{{ l.estadoPipeline }}</span></td>
                <td>
                  <span class="badge rounded-pill"
                    [class.bg-danger-subtle]="l.prioridad === 'alta'" [class.text-danger]="l.prioridad === 'alta'"
                    [class.bg-warning-subtle]="l.prioridad === 'media'" [class.text-warning]="l.prioridad === 'media'"
                    [class.bg-success-subtle]="l.prioridad === 'baja'" [class.text-success]="l.prioridad === 'baja'">
                    {{ l.prioridad }}
                  </span>
                </td>
                <td class="text-muted">{{ l.ticketEstimado | currency:'USD':'symbol':'1.0-0' }}</td>
                <td class="text-end pe-4">
                  <div class="btn-group">
                    <a [routerLink]="['/leads', l.id]" class="btn btn-sm btn-light" title="Ver"><i class="bi bi-eye"></i></a>
                    <a [routerLink]="['/leads', l.id, 'edit']" class="btn btn-sm btn-light" title="Editar"><i class="bi bi-pencil"></i></a>
                    <button type="button" class="btn btn-sm btn-light text-danger" (click)="confirmDelete(l)" title="Eliminar"><i class="bi bi-trash"></i></button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="card-footer bg-white border-top-0 py-3">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" [class.disabled]="page() <= 1">
              <a class="page-link border-0" (click)="setPage(page() - 1)"><i class="bi bi-chevron-left"></i></a>
            </li>
            <li class="page-item disabled"><span class="page-link border-0 text-muted">{{ page() }} / {{ totalPages() }}</span></li>
            <li class="page-item" [class.disabled]="page() >= totalPages()">
              <a class="page-link border-0" (click)="setPage(page() + 1)"><i class="bi bi-chevron-right"></i></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  } @else {
    <!-- Kanban: ancho completo, arrastrar para desplazar, doble clic para abrir lead -->
    <div class="kanban-full-width">
      <div class="kanban-board" (mousedown)="kanbanDragStart($event)" [class.kanban-dragging]="kanbanDragging()"
           (touchstart)="kanbanTouchStart($event)" role="region" aria-label="Kanban de leads">
        <div class="kanban-board-inner d-flex flex-nowrap gap-3 pb-3" style="min-height: 600px;">
        @for (col of kanbanColumns; track col.id) {
          <div class="kanban-column flex-shrink-0">
            <div class="kanban-column__header">
              <span class="kanban-column__label">{{ col.label }}</span>
              <span class="kanban-column__count">{{ getLeadsByStatus(col.id).length }}</span>
            </div>
            <div class="d-flex flex-column gap-2 kanban-cards">
              @for (l of getLeadsByStatus(col.id); track l.id) {
                <div class="kanban-card" [class.kanban-card-priority-alta]="l.prioridad === 'alta'"
                     [class.kanban-card-priority-media]="l.prioridad === 'media'"
                     [class.kanban-card-priority-baja]="l.prioridad === 'baja'"
                     (dblclick)="openLead(l.id)" (click)="$event.stopPropagation()"
                     role="button" tabindex="0" (keydown.enter)="openLead(l.id)" (keydown.space)="openLead(l.id)">
                  <div class="kanban-card__meta">
                    <span class="kanban-card__value">{{ l.ticketEstimado | currency:'USD':'symbol':'1.0-0' }}</span>
                    <span class="kanban-card__priority" [attr.data-prioridad]="l.prioridad">{{ l.prioridad }}</span>
                  </div>
                  <h3 class="kanban-card__name text-truncate">{{ l.nombre }}</h3>
                  <p class="kanban-card__company text-truncate">{{ l.empresa }}</p>
                  <div class="kanban-card__footer">
                    <span class="kanban-card__date">Actualizado {{ l.updatedAt | date:'d MMM' }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        </div>
      </div>
    </div>
  }
}

@if (leadToDelete()) {
  <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Confirmar eliminación</h5>
          <button type="button" class="btn-close" (click)="leadToDelete.set(null)"></button>
        </div>
        <div class="modal-body text-center py-4">
          <div class="mb-3 text-danger"><i class="bi bi-exclamation-circle display-1"></i></div>
          <p class="mb-0">¿Estás seguro de eliminar a <strong>{{ leadToDelete()!.nombre }}</strong>?</p>
          <p class="text-muted small">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer border-0 justify-content-center pt-0 pb-4">
          <button type="button" class="btn btn-light px-4" (click)="leadToDelete.set(null)">Cancelar</button>
          <button type="button" class="btn btn-danger px-4" (click)="doDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
}
